<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Espanglish - Votar</title>
	<link rel="shortcut icon" href="iconn.ico" >
	<link rel="stylesheet" href="app/css/estilo.css">
	<link type="text/css" rel="stylesheet" href="app/materialize/css/materialize.min.css"  media="screen,projection"/>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	
</head>
<body class="esmaecer">
	<nav class="green accent-4">
		<div class="nav-wrapper">

			<a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
			<ul class="left hide-on-med-and-down">
				<li class="active"> <a href="votar.html" type="button" style="width: 100%" >Votar</a></li>
				<li ><a href="index.html" type="button" style="width: 100%">Sobre</a></li>
				<li><a href="paises.html" type="button" style="width: 100%">Países</a></li>

			</ul>
			<ul class="side-nav" id="mobile-demo">
				<li class="active"><a href="votar.html" type="button" style="width: 100%" >Votar</a></li>
				<li ><a href="index.html" type="button" style="width: 100%">Sobre</a></li>
				<li><a href="paises.html" type="button" style="width: 100%">Países</a></li>

			</ul>
		</div>
	</nav>
	<div class="container " style="margin-top: 5%;">
		<div class="row">
			<div class="col l4 m4 offset-m4 offset-l4">   
				<img class="responsive-img center" src="app/img/logo.png" alt="Espanglish!"/> 
			</div>
		</div>
		<div id="preloader" class="preloader-wrapper active" style="display: none;
			position: absolute;
			top :0;
			left: 0;
			right: 0;
			bottom: 0;
			margin: auto;
			z-index: 100;
			">
		    <div class="spinner-layer spinner-red-only">
		      <div class="circle-clipper left">
		        <div class="circle"></div>
		      </div><div class="gap-patch">
		        <div class="circle"></div>
		      </div><div class="circle-clipper right">
		        <div class="circle"></div>
		      </div>
		    </div>
		  </div>

		<div class="row">
			<form class="col s12" method="post">
				<div class="row">
					<div class="input-field col s12 m6 l6 offset-m3 offset-l3">
						<input type="text" name="v_nome" id="nome" required aria-describedby="img1" class="validate">
						<label for="nome">Qual seu nome?</label>
					</div> 
					<div class="input-field col s12 m6 l6 offset-m3 offset-l3">
						<input type="text" name="cpf_name" onblur="Mascara();" id="cpf" required aria-describedby="img1" class="validate">
						<label for="cpf">Qual seu CPF?</label>
					</div>
				
				<div style="display: none;color: red" class="alert alert-danger col-md-4 col-md-offset-4 input-group" id="ErroCpf">Preencha o campo com o seu CPF corretamente</div>
				<div style="display: none;color: red" class="alert alert-danger col-md-4 col-md-offset-4 input-group" id="CPFcadastrado">CPF já cadastrado !</div>
				
				<h5 class="col m6 l6 s12 offset-m3 offset-l3">Qual país mais se destacou?</h5>
					<div class="input-field col s12 m6 l6 offset-m3 offset-l3">
						<select id="Bandeiras" class="icons">
							<option value="" disabled selected>Carregando...</option>
						</select>
						<label>Selecione uma País</label>
					</div>
				</div>
				<div style="display: none" class="alert alert-danger col-md-4 col-md-offset-4 m2 input-group" id="ErroPais">Selecione um Pais!</div>
				<div class="col-md-offset-4  input-group m2" id="div1"></div>
				<div class="row">
<div id="confirmacao" class="col s12 m8" style="position: absolute; top: 50%;display: none; margin: auto;">
	<div class="card blue-grey darken-1">
		<div class="card-content white-text">
			<span class="card-title">Deseja confirmar seu voto em <span id="recebeNome"></span>?</span>
			
		</div>
		<div class="card-action">
			<input type="submit" value="Confirmar" id="votar" class="btn btn-success"/>
			<input type="button" value="Cancelar" id="cancelar" class="btn btn-danger" style="background: red">
		</div>
		</div>
	</div>
</div>
<div id="msg" class="col s12 m6" style="position: absolute; top: 50%;width: 95%;display: none">
	<div class="card blue-grey darken-1">
		<div class="card-content white-text">
			<span class="card-title" id="recebeMsg"></span>
		</div>
		<div class="card-action">
			<input type="submit" value="Confirmar" id="fecharMsg" class="btn btn-success"/>
		</div>
		</div>
	</div>
</div>

				<input type="button" value="Votar" id="confirm" class="btn btn-success" style="width: 95%;margin-top: 3.5%; margin-bottom: 10%;"/>
			</div>
		</form>
	</div>
</div>

<div id="erros"></div>
<footer class="page-footer green accent-4">
	<div class="footer-copyright">
		<div class="container">
			<p class="center mt3">Developed by <a id="procoders" class="red-text text-accent-4" href="grupo.html"> Alcatéia</a> team © 2017</p>
		</div>
	</div>
</footer>
<script type="text/javascript" src="app/js/jquery3-1.js"></script>
<script type="text/javascript" src="app/bootstrap/js/mask.js"></script>
<script type="text/javascript" src="app/materialize/js/materialize.min.js"></script>
<script type="text/javascript">
	
	function ErroCPF(){
		$('#ErroCpf').show("fast",function(){setTimeout(function(){ $("#ErroCpf").hide(); }, 15000)});
		$('#CPFcadastrado').hide('fast');
	}
	function CPFcadastrado(){
		$('#ErroCpf').hide('fast');
		$('#CPFcadastrado').show("fast",function(){setTimeout(function(){ $("#ErroCpf").hide(); }, 15000)});
	}
	function TestaCPF(strCPF) { 
		var Soma; 
		var Resto;
		Soma = 0; 
		if (strCPF == "00000000000") return false; 
		for (i=1; i<=9; i++) Soma = Soma + parseInt(strCPF.substring(i-1, i)) * (11 - i); 
			Resto = (Soma * 10) % 11; 
		if ((Resto == 10) || (Resto == 11)) Resto = 0; 
		if (Resto != parseInt(strCPF.substring(9, 10)) ) return false; 
		Soma = 0; 
		for (i = 1; i <= 10; i++) Soma = Soma + parseInt(strCPF.substring(i-1, i)) * (12 - i); Resto = (Soma * 10) % 11; 
			if ((Resto == 10) || (Resto == 11)) Resto = 0; 
		if (Resto != parseInt(strCPF.substring(10, 11) ) ) return false; 
		return true; 
	}
	$(document).ready(function($) {
		$(".button-collapse").sideNav();
		$('select').material_select();
		solicitacao();
		$.ajax({
			url: 'back/Publico.php',
			type: 'POST',
			dataType: 'html',
			data: 'tipo=buscar',

		})
		.done(function(volta) {
			$("#Bandeiras").html(volta);
			$('select').material_select('destroy');
			$('select').material_select();
		})
		.fail(function() {
			$("#Bandeiras").html("Não foi possivel buscar os Paises, Sem Conexão com a Internet.")
		})
		.always(function() {
			console.log("complete");
		});
		$("#fecharMsg").click(function(event) {
			$("#msg").hide();
		});
		$("#confirm").click(function(event) {
			var nome = $("#nome").val();        
			var cpf = $("#cpf").val().replace(/[^\d]+/g,'');
			var pais = $( "#pais option:selected" ).val();
			var nomepais = $('#Bandeiras option:selected').text();
			var id_pais = $("#Bandeiras").val();
			if(nome == ""){
				$("#ErroNome").show("fast",function(){setTimeout(function(){ $("#ErroNome").hide();}, 15000)});
				$("#nome").addClass('invalid');
			}else if(!TestaCPF(cpf)){
				$("#ErroNome").hide();
				$('#CPFcadastrado').hide('fast');
				$('#ErroCpf').show("fast",function(){setTimeout(function(){ $("#ErroCpf").hide(); }, 15000)});
				$("#cpf").addClass('invalid');
			}else{
				$('#ErroCpf').hide();
				$("#recebeNome").html(nomepais);
				$("#confirmacao").show("fast");
			}
		});
		$("#cancelar").click(function(event) {
			$("#confirmacao").hide();
			$("#preloader").hide();
		});
		$("form").submit(function(event) {
			return false;
			/* Act on the event */
		});
		$("#votar").click(function(){   
			$(".esmaecer").css({
   				"background-color": "rgba(#000, .4)",
    			"z-index": "2"
			});
			$("#preloader").show();
			$("#votar").attr('disabled','disabled');
			var nome = $("#nome").val();        
			var cpf = $("#cpf").val().replace(/[^\d]+/g,'');
			var pais = $( "#pais option:selected" ).val();
			var nomepais = $("input:radio[name=paises]:checked").attr('nome');
			var id_pais = $("#Bandeiras").val();
			if(nome == ""){
				$("#ErroNome").show("fast",function(){setTimeout(function(){ $("#ErroNome").hide(); }, 15000)});
				
			}else if(!TestaCPF(cpf)){
				$("#ErroNome").hide();
				$('#CPFcadastrado').hide('fast');
				$('#ErroCpf').show("fast",function(){setTimeout(function(){ $("#ErroCpf").hide(); }, 15000)});
				$("#preloader").hide();
			}else{
			$('#ErroCpf').hide();
				$.ajax({
					url: 'back/Publico.php',
					type: 'POST',
					dataType: 'html',
					data: 'nome='+nome+'&cpf='+cpf+'&paise_id='+id_pais+'&tipo=SalvarVoto',
				})
				.done(function(res) {
					$("#div1").html(res);
					$("#nome").val("");
					$("#cpf").val("");
						//window.location.href='index.html';
					})
				.fail(function() {
					alert("Sem conexão com a Internet, por favor tente novamente!");
				})
				.always(function() {
					console.log("complete");
					$("#votar").removeAttr('disabled');
					$("#preloader").hide();
				});
				
				return false;
			}

		});
		
	});
	function confirmado(nome){
		alert("Você votou no Pais "+nome+"! Obrigado")
		history.back();
	}
	
	function solicitacao()
	{
		$.ajax({
			url: 'back/Verificacao.php',
			type: 'POST',
			dataType: 'html',
			data: "liberacao=verifica",
		})
		.done(function(volta) {
			if(volta == "Permitido"){
				Verificar('true');
			}else if(volta == "Negado"){
				Verificar('false');
			}
		})
		.fail(function() {
			console.log("error");
		})
		.always(function() {
			console.log("complete");
		});

	}

	function Verificar(check){
		if(check == 'true'){
			document.getElementById("confirm").removeAttribute("disabled");
		}else if(check == 'false'){
			$("#confirm").attr('disabled','disabled');
		}
	}
	function Mascara(){
		$("#cpf").mask('999.999.999-99');
	}
</script>
</body>
</html>
